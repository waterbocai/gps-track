# -*- coding: utf-8 -*-

import urllib  
import urllib2  
from urllib import urlencode 
import json  
import sys
import time
import random
import string
import hashlib
import datetime 

class JSJDKSign:
    def __init__(self,appid):
        self.appid = appid

    def __create_nonce_str(self):
        return ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(15))

    def __create_timestamp(self):
        return int(time.time())

    def jdkSign(self,jsapi_ticket, url,nonceStr="",timestamp=""):
        test = True
        if nonceStr== "":
            test = False
            nonceStr  = self.__create_nonce_str()
        if timestamp=="":
            timestamp = self.__create_timestamp()
        #处理url中#字符情况
        temp= url.split("#")[0]
        ret = {
            'nonceStr': nonceStr,
            'jsapi_ticket': jsapi_ticket,
            'timestamp': timestamp,
            'url': temp
        }
        string = '&'.join(['%s=%s' % (key.lower(), ret[key]) for key in sorted(ret)])
        ret['signature'] = hashlib.sha1(string).hexdigest()
        ret['appid'] = self.appid
        ret['url'] = url
        #ret['string'] = string
        return ret
    
    def paySign(self,prepay_id,nonceStr="",timestamp="",appid="",package=""):
        test = True
        if nonceStr== "":
            test = False
            nonceStr  = self.__create_nonce_str()
        if timestamp=="":
            timestamp = self.__create_timestamp()
        if appid =="" :
            appid = self.appid
        if package=="":
            package = 'prepay_id={0}'.format(prepay_id)
        if appid =="":
            appid = self.appid
        
        ret = {
            'appId'    :appid,
            'timestamp': timestamp,
            'nonceStr' : nonceStr,
            'package'  : package,
            'signType' :'MD5',
        }
        string = '&'.join(['%s=%s' % (key.lower(), ret[key]) for key in sorted(ret)])
        ret['paySign'] = hashlib.sha1(string).hexdigest().upper()
        if test:
            ret['string'] = string
        return ret
        
